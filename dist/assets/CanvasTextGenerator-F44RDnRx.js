import{D as z,n as O,R as _,C as G}from"./index-DDZL8cFr.js";import{C as A}from"./CanvasPool-AohZQnYu.js";import{C as v,f as H,g as W}from"./getCanvasFillStyle-Bhfzdggk.js";let C=null,g=null;function X(p,a){C||(C=z.get().createCanvas(256,128),g=C.getContext("2d",{willReadFrequently:!0}),g.globalCompositeOperation="copy",g.globalAlpha=1),(C.width<p||C.height<a)&&(C.width=O(p),C.height=O(a))}function D(p,a,e){for(let o=0,n=4*e*a;o<a;++o,n+=4)if(p[n+3]!==0)return!1;return!0}function R(p,a,e,o,n){const i=4*a;for(let c=o,t=o*i+4*e;c<=n;++c,t+=i)if(p[t+3]!==0)return!1;return!0}function $(...p){let a=p[0];a.canvas||(a={canvas:p[0],resolution:p[1]});const{canvas:e}=a,o=Math.min(a.resolution??1,1),n=a.width??e.width,i=a.height??e.height;let c=a.output;if(X(n,i),!g)throw new TypeError("Failed to get canvas 2D context");g.drawImage(e,0,0,n,i,0,0,n*o,i*o);const h=g.getImageData(0,0,n,i).data;let r=0,s=0,d=n-1,f=i-1;for(;s<i&&D(h,n,s);)++s;if(s===i)return _.EMPTY;for(;D(h,n,f);)--f;for(;R(h,n,r,s,f);)++r;for(;R(h,n,d,s,f);)--d;return++d,++f,g.globalCompositeOperation="source-over",g.strokeRect(r,s,d-r,f-s),g.globalCompositeOperation="copy",c??(c=new _),c.set(r/o,s/o,(d-r)/o,(f-s)/o),c}const B=new _;class q{getCanvasAndContext(a){const{text:e,style:o,resolution:n=1}=a,i=o._getFinalPadding(),c=v.measureText(e||" ",o),t=Math.ceil(Math.ceil(Math.max(1,c.width)+i*2)*n),h=Math.ceil(Math.ceil(Math.max(1,c.height)+i*2)*n),r=A.getOptimalCanvasAndContext(t,h);this._renderTextToCanvas(e,o,i,n,r);const s=o.trim?$({canvas:r.canvas,width:t,height:h,resolution:1,output:B}):B.set(0,0,t,h);return{canvasAndContext:r,frame:s}}returnCanvasAndContext(a){A.returnCanvasAndContext(a)}_renderTextToCanvas(a,e,o,n,i){const{canvas:c,context:t}=i,h=H(e),r=v.measureText(a||" ",e),s=r.lines,d=r.lineHeight,f=r.lineWidths,S=r.maxLineWidth,u=r.fontProperties,T=c.height;if(t.resetTransform(),t.scale(n,n),t.textBaseline=e.textBaseline,e._stroke?.width){const m=e._stroke;t.lineWidth=m.width,t.miterLimit=m.miterLimit,t.lineJoin=m.join,t.lineCap=m.cap}t.font=h;let w,x;const F=e.dropShadow?2:1;for(let m=0;m<F;++m){const M=e.dropShadow&&m===0,k=M?Math.ceil(Math.max(1,T)+o*2):0,Y=k*n;if(M){t.fillStyle="black",t.strokeStyle="black";const l=e.dropShadow,E=l.color,I=l.alpha;t.shadowColor=G.shared.setValue(E).setAlpha(I).toRgbaString();const j=l.blur*n,b=l.distance*n;t.shadowBlur=j,t.shadowOffsetX=Math.cos(l.angle)*b,t.shadowOffsetY=Math.sin(l.angle)*b+Y}else{if(t.fillStyle=e._fill?W(e._fill,t,r,o*2):null,e._stroke?.width){const l=e._stroke.width*.5+o*2;t.strokeStyle=W(e._stroke,t,r,l)}t.shadowColor="black"}let L=(d-u.fontSize)/2;d-u.fontSize<0&&(L=0);const P=e._stroke?.width??0;for(let l=0;l<s.length;l++)w=P/2,x=P/2+l*d+u.ascent+L,e.align==="right"?w+=S-f[l]:e.align==="center"&&(w+=(S-f[l])/2),e._stroke?.width&&this._drawLetterSpacing(s[l],e,i,w+o,x+o-k,!0),e._fill!==void 0&&this._drawLetterSpacing(s[l],e,i,w+o,x+o-k)}}_drawLetterSpacing(a,e,o,n,i,c=!1){const{context:t}=o,h=e.letterSpacing;let r=!1;if(v.experimentalLetterSpacingSupported&&(v.experimentalLetterSpacing?(t.letterSpacing=`${h}px`,t.textLetterSpacing=`${h}px`,r=!0):(t.letterSpacing="0px",t.textLetterSpacing="0px")),h===0||r){c?t.strokeText(a,n,i):t.fillText(a,n,i);return}let s=n;const d=v.graphemeSegmenter(a);let f=t.measureText(a).width,S=0;for(let u=0;u<d.length;++u){const T=d[u];c?t.strokeText(T,s,i):t.fillText(T,s,i);let w="";for(let x=u+1;x<d.length;++x)w+=d[x];S=t.measureText(w).width,s+=f-S+h,f=S}}}const N=new q;export{N as C};
