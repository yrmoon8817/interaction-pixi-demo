import{D as z,E as O,u as V,G as y,t as H,o as M,C,F as b,p as I,a as N,v as R,w as G,T as j,M as $}from"./index-DDZL8cFr.js";class K{constructor(t=0,e=0,i=!1){this.first=null,this.items=Object.create(null),this.last=null,this.max=t,this.resetTtl=i,this.size=0,this.ttl=e}clear(){return this.first=null,this.items=Object.create(null),this.last=null,this.size=0,this}delete(t){if(this.has(t)){const e=this.items[t];delete this.items[t],this.size--,e.prev!==null&&(e.prev.next=e.next),e.next!==null&&(e.next.prev=e.prev),this.first===e&&(this.first=e.next),this.last===e&&(this.last=e.prev)}return this}entries(t=this.keys()){return t.map(e=>[e,this.get(e)])}evict(t=!1){if(t||this.size>0){const e=this.first;delete this.items[e.key],--this.size===0?(this.first=null,this.last=null):(this.first=e.next,this.first.prev=null)}return this}expiresAt(t){let e;return this.has(t)&&(e=this.items[t].expiry),e}get(t){const e=this.items[t];if(e!==void 0){if(this.ttl>0&&e.expiry<=Date.now()){this.delete(t);return}return this.moveToEnd(e),e.value}}has(t){return t in this.items}moveToEnd(t){this.last!==t&&(t.prev!==null&&(t.prev.next=t.next),t.next!==null&&(t.next.prev=t.prev),this.first===t&&(this.first=t.next),t.prev=this.last,t.next=null,this.last!==null&&(this.last.next=t),this.last=t,this.first===null&&(this.first=t))}keys(){const t=[];let e=this.first;for(;e!==null;)t.push(e.key),e=e.next;return t}setWithEvicted(t,e,i=this.resetTtl){let n=null;if(this.has(t))this.set(t,e,!0,i);else{this.max>0&&this.size===this.max&&(n={...this.first},this.evict(!0));let r=this.items[t]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:t,prev:this.last,next:null,value:e};++this.size===1?this.first=r:this.last.next=r,this.last=r}return n}set(t,e,i=!1,n=this.resetTtl){let r=this.items[t];return i||r!==void 0?(r.value=e,i===!1&&n&&(r.expiry=this.ttl>0?Date.now()+this.ttl:this.ttl),this.moveToEnd(r)):(this.max>0&&this.size===this.max&&this.evict(!0),r=this.items[t]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:t,prev:this.last,next:null,value:e},++this.size===1?this.first=r:this.last.next=r,this.last=r),this}values(t=this.keys()){return t.map(e=>this.get(e))}}function U(o=1e3,t=0,e=!1){if(isNaN(o)||o<0)throw new TypeError("Invalid max value");if(isNaN(t)||t<0)throw new TypeError("Invalid ttl value");if(typeof e!="boolean")throw new TypeError("Invalid resetTtl value");return new K(o,t,e)}const q=["serif","sans-serif","monospace","cursive","fantasy","system-ui"];function Y(o){const t=typeof o.fontSize=="number"?`${o.fontSize}px`:o.fontSize;let e=o.fontFamily;Array.isArray(o.fontFamily)||(e=o.fontFamily.split(","));for(let i=e.length-1;i>=0;i--){let n=e[i].trim();!/([\"\'])[^\'\"]+\1/.test(n)&&!q.includes(n)&&(n=`"${n}"`),e[i]=n}return`${o.fontStyle} ${o.fontVariant} ${o.fontWeight} ${t} ${e.join(",")}`}const E={willReadFrequently:!0},_=class s{static get experimentalLetterSpacingSupported(){let t=s._experimentalLetterSpacingSupported;if(t===void 0){const e=z.get().getCanvasRenderingContext2D().prototype;t=s._experimentalLetterSpacingSupported="letterSpacing"in e||"textLetterSpacing"in e}return t}constructor(t,e,i,n,r,a,l,c,d){this.text=t,this.style=e,this.width=i,this.height=n,this.lines=r,this.lineWidths=a,this.lineHeight=l,this.maxLineWidth=c,this.fontProperties=d}static measureText(t=" ",e,i=s._canvas,n=e.wordWrap){const r=`${t}-${e.styleKey}-wordWrap-${n}`;if(s._measurementCache.has(r))return s._measurementCache.get(r);const a=Y(e),l=s.measureFont(a);l.fontSize===0&&(l.fontSize=e.fontSize,l.ascent=e.fontSize);const c=s.__context;c.font=a;const u=(n?s._wordWrap(t,e,i):t).split(/(?:\r\n|\r|\n)/),h=new Array(u.length);let f=0;for(let k=0;k<u.length;k++){const x=s._measureText(u[k],e.letterSpacing,c);h[k]=x,f=Math.max(f,x)}const p=e._stroke?.width||0;let S=f+p;e.dropShadow&&(S+=e.dropShadow.distance);const m=e.lineHeight||l.fontSize;let W=Math.max(m,l.fontSize+p)+(u.length-1)*(m+e.leading);e.dropShadow&&(W+=e.dropShadow.distance);const g=new s(t,e,S,W,u,h,m+e.leading,f,l);return s._measurementCache.set(r,g),g}static _measureText(t,e,i){let n=!1;s.experimentalLetterSpacingSupported&&(s.experimentalLetterSpacing?(i.letterSpacing=`${e}px`,i.textLetterSpacing=`${e}px`,n=!0):(i.letterSpacing="0px",i.textLetterSpacing="0px"));const r=i.measureText(t);let a=r.width;const l=-r.actualBoundingBoxLeft;let d=r.actualBoundingBoxRight-l;if(a>0)if(n)a-=e,d-=e;else{const u=(s.graphemeSegmenter(t).length-1)*e;a+=u,d+=u}return Math.max(a,d)}static _wordWrap(t,e,i=s._canvas){const n=i.getContext("2d",E);let r=0,a="",l="";const c=Object.create(null),{letterSpacing:d,whiteSpace:u}=e,h=s._collapseSpaces(u),f=s._collapseNewlines(u);let p=!h;const S=e.wordWrapWidth+d,m=s._tokenize(t);for(let W=0;W<m.length;W++){let g=m[W];if(s._isNewline(g)){if(!f){l+=s._addLine(a),p=!h,a="",r=0;continue}g=" "}if(h){const x=s.isBreakingSpace(g),w=s.isBreakingSpace(a[a.length-1]);if(x&&w)continue}const k=s._getFromCache(g,d,c,n);if(k>S)if(a!==""&&(l+=s._addLine(a),a="",r=0),s.canBreakWords(g,e.breakWords)){const x=s.wordWrapSplit(g);for(let w=0;w<x.length;w++){let F=x[w],A=F,B=1;for(;x[w+B];){const L=x[w+B];if(!s.canBreakChars(A,L,g,w,e.breakWords))F+=L;else break;A=L,B++}w+=B-1;const P=s._getFromCache(F,d,c,n);P+r>S&&(l+=s._addLine(a),p=!1,a="",r=0),a+=F,r+=P}}else{a.length>0&&(l+=s._addLine(a),a="",r=0);const x=W===m.length-1;l+=s._addLine(g,!x),p=!1,a="",r=0}else k+r>S&&(p=!1,l+=s._addLine(a),a="",r=0),(a.length>0||!s.isBreakingSpace(g)||p)&&(a+=g,r+=k)}return l+=s._addLine(a,!1),l}static _addLine(t,e=!0){return t=s._trimRight(t),t=e?`${t}
`:t,t}static _getFromCache(t,e,i,n){let r=i[t];return typeof r!="number"&&(r=s._measureText(t,e,n)+e,i[t]=r),r}static _collapseSpaces(t){return t==="normal"||t==="pre-line"}static _collapseNewlines(t){return t==="normal"}static _trimRight(t){if(typeof t!="string")return"";for(let e=t.length-1;e>=0;e--){const i=t[e];if(!s.isBreakingSpace(i))break;t=t.slice(0,-1)}return t}static _isNewline(t){return typeof t!="string"?!1:s._newlines.includes(t.charCodeAt(0))}static isBreakingSpace(t,e){return typeof t!="string"?!1:s._breakingSpaces.includes(t.charCodeAt(0))}static _tokenize(t){const e=[];let i="";if(typeof t!="string")return e;for(let n=0;n<t.length;n++){const r=t[n],a=t[n+1];if(s.isBreakingSpace(r,a)||s._isNewline(r)){i!==""&&(e.push(i),i=""),r==="\r"&&a===`
`?(e.push(`\r
`),n++):e.push(r);continue}i+=r}return i!==""&&e.push(i),e}static canBreakWords(t,e){return e}static canBreakChars(t,e,i,n,r){return!0}static wordWrapSplit(t){return s.graphemeSegmenter(t)}static measureFont(t){if(s._fonts[t])return s._fonts[t];const e=s._context;e.font=t;const i=e.measureText(s.METRICS_STRING+s.BASELINE_SYMBOL),n={ascent:i.actualBoundingBoxAscent,descent:i.actualBoundingBoxDescent,fontSize:i.actualBoundingBoxAscent+i.actualBoundingBoxDescent};return s._fonts[t]=n,n}static clearMetrics(t=""){t?delete s._fonts[t]:s._fonts={}}static get _canvas(){if(!s.__canvas){let t;try{const e=new OffscreenCanvas(0,0);if(e.getContext("2d",E)?.measureText)return s.__canvas=e,e;t=z.get().createCanvas()}catch{t=z.get().createCanvas()}t.width=t.height=10,s.__canvas=t}return s.__canvas}static get _context(){return s.__context||(s.__context=s._canvas.getContext("2d",E)),s.__context}};_.METRICS_STRING="|ÉqÅ";_.BASELINE_SYMBOL="M";_.BASELINE_MULTIPLIER=1.4;_.HEIGHT_MULTIPLIER=2;_.graphemeSegmenter=(()=>{if(typeof Intl?.Segmenter=="function"){const o=new Intl.Segmenter;return t=>{const e=o.segment(t),i=[];let n=0;for(const r of e)i[n++]=r.segment;return i}}return o=>[...o]})();_.experimentalLetterSpacing=!1;_._fonts={};_._newlines=[10,13];_._breakingSpaces=[9,32,8192,8193,8194,8195,8196,8197,8198,8200,8201,8202,8287,12288];_._measurementCache=U(1e3);let Z=_;const v=class T extends O{constructor(t={}){super(),this.uid=V("textStyle"),this._tick=0,Q(t);const e={...T.defaultTextStyle,...t};for(const i in e){const n=i;this[n]=e[i]}this.update(),this._tick=0}get align(){return this._align}set align(t){this._align!==t&&(this._align=t,this.update())}get breakWords(){return this._breakWords}set breakWords(t){this._breakWords!==t&&(this._breakWords=t,this.update())}get dropShadow(){return this._dropShadow}set dropShadow(t){this._dropShadow!==t&&(t!==null&&typeof t=="object"?this._dropShadow=this._createProxy({...T.defaultDropShadow,...t}):this._dropShadow=t?this._createProxy({...T.defaultDropShadow}):null,this.update())}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily!==t&&(this._fontFamily=t,this.update())}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(typeof t=="string"?this._fontSize=parseInt(t,10):this._fontSize=t,this.update())}get fontStyle(){return this._fontStyle}set fontStyle(t){this._fontStyle!==t&&(this._fontStyle=t.toLowerCase(),this.update())}get fontVariant(){return this._fontVariant}set fontVariant(t){this._fontVariant!==t&&(this._fontVariant=t,this.update())}get fontWeight(){return this._fontWeight}set fontWeight(t){this._fontWeight!==t&&(this._fontWeight=t,this.update())}get leading(){return this._leading}set leading(t){this._leading!==t&&(this._leading=t,this.update())}get letterSpacing(){return this._letterSpacing}set letterSpacing(t){this._letterSpacing!==t&&(this._letterSpacing=t,this.update())}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this.update())}get padding(){return this._padding}set padding(t){this._padding!==t&&(this._padding=t,this.update())}get filters(){return this._filters}set filters(t){this._filters!==t&&(this._filters=Object.freeze(t),this.update())}get trim(){return this._trim}set trim(t){this._trim!==t&&(this._trim=t,this.update())}get textBaseline(){return this._textBaseline}set textBaseline(t){this._textBaseline!==t&&(this._textBaseline=t,this.update())}get whiteSpace(){return this._whiteSpace}set whiteSpace(t){this._whiteSpace!==t&&(this._whiteSpace=t,this.update())}get wordWrap(){return this._wordWrap}set wordWrap(t){this._wordWrap!==t&&(this._wordWrap=t,this.update())}get wordWrapWidth(){return this._wordWrapWidth}set wordWrapWidth(t){this._wordWrapWidth!==t&&(this._wordWrapWidth=t,this.update())}get fill(){return this._originalFill}set fill(t){t!==this._originalFill&&(this._originalFill=t,this._isFillStyle(t)&&(this._originalFill=this._createProxy({...y.defaultFillStyle,...t},()=>{this._fill=H({...this._originalFill},y.defaultFillStyle)})),this._fill=H(t===0?"black":t,y.defaultFillStyle),this.update())}get stroke(){return this._originalStroke}set stroke(t){t!==this._originalStroke&&(this._originalStroke=t,this._isFillStyle(t)&&(this._originalStroke=this._createProxy({...y.defaultStrokeStyle,...t},()=>{this._stroke=M({...this._originalStroke},y.defaultStrokeStyle)})),this._stroke=M(t,y.defaultStrokeStyle),this.update())}update(){this._tick++,this.emit("update",this)}reset(){const t=T.defaultTextStyle;for(const e in t)this[e]=t[e]}get styleKey(){return`${this.uid}-${this._tick}`}clone(){return new T({align:this.align,breakWords:this.breakWords,dropShadow:this._dropShadow?{...this._dropShadow}:null,fill:this._fill,fontFamily:this.fontFamily,fontSize:this.fontSize,fontStyle:this.fontStyle,fontVariant:this.fontVariant,fontWeight:this.fontWeight,leading:this.leading,letterSpacing:this.letterSpacing,lineHeight:this.lineHeight,padding:this.padding,stroke:this._stroke,textBaseline:this.textBaseline,whiteSpace:this.whiteSpace,wordWrap:this.wordWrap,wordWrapWidth:this.wordWrapWidth,filters:this._filters?[...this._filters]:void 0})}_getFinalPadding(){let t=0;if(this._filters)for(let e=0;e<this._filters.length;e++)t+=this._filters[e].padding;return Math.max(this._padding,t)}destroy(t=!1){if(this.removeAllListeners(),typeof t=="boolean"?t:t?.texture){const i=typeof t=="boolean"?t:t?.textureSource;this._fill?.texture&&this._fill.texture.destroy(i),this._originalFill?.texture&&this._originalFill.texture.destroy(i),this._stroke?.texture&&this._stroke.texture.destroy(i),this._originalStroke?.texture&&this._originalStroke.texture.destroy(i)}this._fill=null,this._stroke=null,this.dropShadow=null,this._originalStroke=null,this._originalFill=null}_createProxy(t,e){return new Proxy(t,{set:(i,n,r)=>(i[n]===r||(i[n]=r,e?.(n,r),this.update()),!0)})}_isFillStyle(t){return(t??null)!==null&&!(C.isColorLike(t)||t instanceof b||t instanceof I)}};v.defaultDropShadow={alpha:1,angle:Math.PI/6,blur:0,color:"black",distance:5};v.defaultTextStyle={align:"left",breakWords:!1,dropShadow:null,fill:"black",fontFamily:"Arial",fontSize:26,fontStyle:"normal",fontVariant:"normal",fontWeight:"normal",leading:0,letterSpacing:0,lineHeight:0,padding:0,stroke:null,textBaseline:"alphabetic",trim:!1,whiteSpace:"pre",wordWrap:!1,wordWrapWidth:100};let J=v;function Q(o){const t=o;if(typeof t.dropShadow=="boolean"&&t.dropShadow){const e=J.defaultDropShadow;o.dropShadow={alpha:t.dropShadowAlpha??e.alpha,angle:t.dropShadowAngle??e.angle,blur:t.dropShadowBlur??e.blur,color:t.dropShadowColor??e.color,distance:t.dropShadowDistance??e.distance}}if(t.strokeThickness!==void 0){N(R,"strokeThickness is now a part of stroke");const e=t.stroke;let i={};if(C.isColorLike(e))i.color=e;else if(e instanceof b||e instanceof I)i.fill=e;else if(Object.hasOwnProperty.call(e,"color")||Object.hasOwnProperty.call(e,"fill"))i=e;else throw new Error("Invalid stroke value.");o.stroke={...i,width:t.strokeThickness}}if(Array.isArray(t.fillGradientStops)){if(N(R,"gradient fill is now a fill pattern: `new FillGradient(...)`"),!Array.isArray(t.fill)||t.fill.length===0)throw new Error("Invalid fill value. Expected an array of colors for gradient fill.");t.fill.length!==t.fillGradientStops.length&&G("The number of fill colors must match the number of fill gradient stops.");const e=new b({start:{x:0,y:0},end:{x:0,y:1},textureSpace:"local"}),i=t.fillGradientStops.slice(),n=t.fill.map(r=>C.shared.setValue(r).toNumber());i.forEach((r,a)=>{e.addColorStop(r,n[a])}),o.fill={fill:e}}}const D=1e5;function tt(o,t,e,i=0){if(o.texture===j.WHITE&&!o.fill)return C.shared.setValue(o.color).setAlpha(o.alpha??1).toHexa();if(o.fill){if(o.fill instanceof I){const n=o.fill,r=t.createPattern(n.texture.source.resource,"repeat"),a=n.transform.copyTo($.shared);return a.scale(n.texture.frame.width,n.texture.frame.height),r.setTransform(a),r}else if(o.fill instanceof b){const n=o.fill,r=n.type==="linear",a=n.textureSpace==="local";let l=1,c=1;a&&e&&(l=e.width+i,c=e.height+i);let d,u=!1;if(r){const{start:h,end:f}=n;d=t.createLinearGradient(h.x*l,h.y*c,f.x*l,f.y*c),u=Math.abs(f.x-h.x)<Math.abs((f.y-h.y)*.1)}else{const{center:h,innerRadius:f,outerCenter:p,outerRadius:S}=n;d=t.createRadialGradient(h.x*l,h.y*c,f*l,p.x*l,p.y*c,S*l)}if(u&&a&&e){const h=e.lineHeight/c;for(let f=0;f<e.lines.length;f++){const p=(f*e.lineHeight+i/2)/c;n.colorStops.forEach(S=>{const m=p+S.offset*h;d.addColorStop(Math.floor(m*D)/D,C.shared.setValue(S.color).toHex())})}}else n.colorStops.forEach(h=>{d.addColorStop(h.offset,C.shared.setValue(h.color).toHex())});return d}}else{const n=t.createPattern(o.texture.source.resource,"repeat"),r=o.matrix.copyTo($.shared);return r.scale(o.texture.frame.width,o.texture.frame.height),n.setTransform(r),n}return G("FillStyle not recognised",o),"red"}export{Z as C,J as T,Y as f,tt as g,U as l};
